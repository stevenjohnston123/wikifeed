<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiFeed - A Social Media View of Wikipedia</title>
    <style>
        /* Basic Reset and Variables */
        :root {
            --primary-color: #0079d3;
            --background-color: #dae0e6;
            --card-background: #ffffff;
            --text-color: #1c1c1c;
            --subtle-text: #7c7c7c;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            padding-top: 20px;
        }

        /* Header and Categories */
        .header {
            background-color: var(--card-background);
            border-bottom: 1px solid #ccc;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .category-selector {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px 15px; 
            padding-bottom: 5px;
            overflow-x: hidden; 
            white-space: normal; 
        }

        .category-button {
            background: none;
            border: none;
            color: var(--subtle-text);
            cursor: pointer;
            padding: 5px 10px;
            font-size: 16px;
            font-weight: bold;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .category-button:hover {
            color: var(--primary-color);
        }

        .category-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Article Card Styles */
        .article-card {
            background-color: var(--card-background);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
        }

        .card-body {
            padding: 15px;
            display: flex;
            gap: 15px;
        }

        .card-content {
            flex-grow: 1;
        }

        .card-title {
            font-size: 1.3em;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 5px;
        }

        .card-title a {
            text-decoration: none;
            color: var(--primary-color);
        }

        .card-title a:hover {
            text-decoration: underline;
        }

        .card-summary {
            color: var(--text-color);
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .card-meta {
            font-size: 0.85em;
            color: var(--subtle-text);
            padding: 0 15px 15px 15px;
            border-top: 1px solid #eee;
        }

        .card-image-container {
            width: 160px;
            height: 120px; 
            flex-shrink: 0;
        }
        
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: var(--subtle-text);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üî• WikiFeed</h2>
            <div class="category-selector">
                <button class="category-button active" data-category="featured">Featured üî•</button>
                <button class="category-button" data-category="science">Science üî¨</button>
                <button class="category-button" data-category="technology">Technology üíª</button>
                <button class="category-button" data-category="mathematics">Mathematics ‚ûó</button>
                <button class="category-button" data-category="history">History üìú</button>
                <button class="category-button" data-category="politics">Politics üèõÔ∏è</button>
                <button class="category-button" data-category="business">Business üìà</button>
                <button class="category-button" data-category="arts">Arts üé®</button>
                <button class="category-button" data-category="literature">Literature üìö</button>
                <button class="category-button" data-category="philosophy">Philosophy ü§î</button>
                <button class="category-button" data-category="music">Music üé∂</button>
                <button class="category-button" data-category="entertainment">Entertainment üé¨</button>
                <button class="category-button" data-category="religion">Religion üôè</button>
                <button class="category-button" data-category="legal">Legal ‚öñÔ∏è</button>
            </div>
        </div>
        
        <div id="feed-container"></div>

        <div id="loading-indicator" class="loading">
            Loading more articles...
        </div>
    </div>

    <script>
        const feedContainer = document.getElementById('feed-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const categoryButtons = document.querySelectorAll('.category-button');

        let currentCategory = 'featured'; 
        let offset = 0; 
        
        // SETTINGS
        const API_BATCH_SIZE = 30; 
        const REQUESTS_PER_LOAD = 2; 
        
        let isLoading = false;
        const loadedArticleIds = new Set();
        
        // Initialize the AbortController for managing in-flight requests
        let activeController = new AbortController(); 
        
        // --- Category Mapping for API ---
        const categoryQueryMap = {
            'featured': 'Featured article',
            'science': 'Physics OR Biology',
            'technology': 'Computer science OR Internet',
            'mathematics': 'Calculus OR Algebra',
            'history': 'World history OR Ancient history',
            'politics': 'Political science OR Government',
            'business': 'Economics OR Finance',
            'arts': 'Visual arts OR Sculpture',
            'literature': 'Literature OR Literary genre OR Author OR Classic novel',
            'philosophy': 'Ethics OR Metaphysics',
            'music': 'Classical music OR Jazz',
            'entertainment': 'Film OR Television',
            'religion': 'Christianity OR Islam',
            'legal': 'Jurisprudence OR Constitution',
        };

        // --- UTILITIES ---

        function calculateTotalViews(pageviewsData) {
             // Change this line:
             if (!pageviewsData) return 0; // Return 0 if data is missing, instead of -1
             
             return Object.values(pageviewsData).reduce((total, dailyViews) => {
                 // This part already correctly handles individual nulls/ -1 as 0
                 const views = (dailyViews === null || dailyViews === -1) ? 0 : dailyViews;
                 return total + views;
             }, 0);
        }

        function cleanTitle(title) {
            return title.replace(/\s*\([^)]*\/[^)]*\)/g, '').trim();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'article-card';

            const cleanArticleTitle = cleanTitle(article.title);
            const rawSummary = article.extract || '';
            const summary = rawSummary.length > 50 ? rawSummary.split('\n')[0].substring(0, 250) + '...' : 'No summary available.';
            
            const imageUrl = article.thumbnail 
                ? article.thumbnail.source 
                : 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/300px-No_image_available.svg.png';
            
            const pageUrl = `https://en.wikipedia.org/?curid=${article.pageid}`;
            const categoryDisplay = article.category.charAt(0).toUpperCase() + article.category.slice(1);
            
            const totalViews = calculateTotalViews(article.pageviews);
            let viewDisplay = 'N/A';
            if (totalViews !== -1) {
                viewDisplay = totalViews.toLocaleString();
            }

            card.innerHTML = `
                <div class="card-body">
                    <div class="card-image-container">
                        <img src="${imageUrl}" alt="Image for ${cleanArticleTitle}" class="card-image">
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">
                            <a href="${pageUrl}" target="_blank">${cleanArticleTitle}</a>
                        </h3>
                        <p class="card-summary">${summary}</p>
                    </div>
                </div>
                <div class="card-meta">
                    Category: <b>wiki/${categoryDisplay}</b> | Views (14 Days): <b>${viewDisplay}</b>
                </div>
            `;
            return card;
        }

        // --- Core Fetching Logic ---
        
        async function fetchArticles() {
            if (isLoading) return; 
            isLoading = true;
            loadingIndicator.style.display = 'block'; 
            
            // 1. Check URL for category on initial load
            const urlParams = new URLSearchParams(window.location.search);
            const urlCategory = urlParams.get('category');
            
            if (urlCategory && categoryQueryMap.hasOwnProperty(urlCategory)) {
                currentCategory = urlCategory;
                categoryButtons.forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`.category-button[data-category="${currentCategory}"]`);
                if (activeBtn) activeBtn.classList.add('active');
            }
            
            const categoryToFetch = currentCategory;
            const searchTopic = categoryQueryMap[categoryToFetch] || 'Featured article';
            const encodedSearchTopic = encodeURIComponent(searchTopic);
            
            const baseApiUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&generator=search&gsrsearch=${encodedSearchTopic}&gsrlimit=${API_BATCH_SIZE}&prop=pageimages|extracts|pageviews&pvipdays=14&exintro&explaintext&exlimit=max&pithumbsize=160&redirects=1&formatversion=2&origin=*`;

            let combinedPages = [];
            let currentOffset = offset;
            let fullLoadComplete = false;
            
            try {
                // 2. Sequential Fetching Loop
                for (let i = 0; i < REQUESTS_PER_LOAD; i++) {
                    // Validity Check
                    if (categoryToFetch !== currentCategory) {
                        break; 
                    }

                    const url = `${baseApiUrl}&gsroffset=${currentOffset}`;
                    
                    // NEW LOGGING ADDED HERE
                    console.log("Fetching URL: " + url);
                    
                    const response = await fetch(url, { signal: activeController.signal }); 
                    const data = await response.json();

                    if (data.query && data.query.pages) {
                        combinedPages = combinedPages.concat(Object.values(data.query.pages));
                    } else {
                        fullLoadComplete = true;
                        break;
                    }
                    
                    currentOffset += API_BATCH_SIZE;
                }
                
                // If the category changed during the await, don't process or update state
                if (categoryToFetch !== currentCategory) {
                    return; 
                }

                offset = currentOffset; 
                
                if (combinedPages.length === 0 && offset === 0) {
                     loadingIndicator.textContent = "Could not find any articles for this category.";
                     return;
                }
                
                // 3. Filter
                let pool = combinedPages.filter(page => {
                    const hasSummary = page.extract && page.extract.length > 50;
                    const hasImage = page.thumbnail;
                    const isNew = !loadedArticleIds.has(page.pageid);

                    if (hasSummary && hasImage && isNew) {
                        loadedArticleIds.add(page.pageid); 
                        return true;
                    }
                    return false;
                });
                
                // 4. Randomize (Shuffle)
                pool = shuffleArray(pool);

                // 5. Render
                if (pool.length === 0) {
                    if (combinedPages.length > 0 && !fullLoadComplete) {
                        loadingIndicator.textContent = "Still loading, trying next batch for quality articles...";
                        isLoading = false; 
                        fetchArticles(); 
                        return;
                    } else {
                        loadingIndicator.textContent = "No more articles found.";
                        return;
                    }
                }
                
                pool.forEach(page => {
                    page.category = categoryToFetch; 
                    feedContainer.appendChild(createArticleCard(page));
                });
                
                loadingIndicator.textContent = "Loading more articles...";

            } catch (error) {
                // Check for AbortError and ignore it gracefully
                if (error.name === 'AbortError') {
                    console.log('Fetch aborted by user action.');
                    return;
                }
                
                console.error("Error fetching articles:", error);
                loadingIndicator.textContent = "Failed to load articles. Please try again.";
            } finally {
                isLoading = false;
            }
        }

        // --- Infinite Scroll Setup ---
        const intersectionCallback = (entries, observer) => {
            const entry = entries[0];
            if (entry.isIntersecting && !isLoading) {
                fetchArticles();
            }
        };

        const observer = new IntersectionObserver(intersectionCallback, {
            root: null, 
            threshold: 0.1
        });

        observer.observe(loadingIndicator);

        // --- Category Switching Logic (CANCELS OLD REQUESTS) ---
        categoryButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newCategory = button.getAttribute('data-category');
                
                if (newCategory !== currentCategory) {
                    // 1. Abort the previous request(s) immediately
                    activeController.abort();
                    // 2. Create a brand new controller for the new request
                    activeController = new AbortController();

                    // Set global state immediately
                    currentCategory = newCategory;
                    
                    // Reset everything
                    offset = 0; 
                    isLoading = false; 
                    loadedArticleIds.clear(); 

                    feedContainer.innerHTML = '';
                    loadingIndicator.textContent = "Loading more articles...";

                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update URL without reloading
                    const newUrl = `${window.location.pathname}?category=${newCategory}`;
                    history.pushState({ category: newCategory }, '', newUrl);

                    // Start the new fetch
                    fetchArticles();
                }
            });
        });
        
        // Initial load
        fetchArticles();

    </script>
</body>
</html>
